<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì•¼êµ¬ë„í•˜ê¸° í€´ì¦ˆ ë“œë¼ì´ë¹™ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <script>
        // ëª¨ë°”ì¼ í™”ë©´ ë†’ì´ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸
        function setScreenHeight() {
            // ì‹¤ì œ ë·°í¬íŠ¸ ë†’ì´ì˜ 1%ë¥¼ CSS ë³€ìˆ˜ --vhë¡œ ì„¤ì •
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setScreenHeight();
        // í™”ë©´ í¬ê¸°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í•¨ìˆ˜ë¥¼ ë‹¤ì‹œ í˜¸ì¶œ
        window.addEventListener('resize', setScreenHeight);
    </script>
    <style>
        body {
            font-family: 'Jua', sans-serif;
            touch-action: manipulation;
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ ë†’ì´ë¥¼ CSS ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì • */
        #game-container {
            /* JSë¡œ ê³„ì‚°ëœ ì‹¤ì œ í™”ë©´ ë†’ì´ë¥¼ ì ìš©. fallbackìœ¼ë¡œ 100vh ì‚¬ìš© */
            height: calc(var(--vh, 1vh) * 100);
        }
        
        /* ë°ìŠ¤í¬íƒ‘ í™”ë©´ì—ì„œëŠ” ìµœëŒ€ ë†’ì´ë¥¼ ì œí•œ */
        @media (min-width: 640px) { /* sm breakpoint */
            #game-container {
                height: 90vh;
                max-height: 800px;
            }
        }
        
        .road-line {
            position: absolute;
            width: 6px;
            height: 100%;
            top: 0;
            background-image: linear-gradient(to bottom, white 50%, transparent 50%);
            background-size: 100% 70px;
            animation: road-lines 2.5s linear infinite;
        }

        @keyframes road-lines {
            from { background-position: 0 0; }
            to { background-position: 0 70px; }
        }

        @keyframes fall {
            from {
                transform: translateY(-100px);
            }
            to {
                transform: translateY(100vh);
            }
        }
        
        .falling {
            animation: fall 10s linear;
        }

        #car {
            transition: left 0.2s ease-out;
        }

        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .modal.hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        #player-name-input {
            border: 2px solid #6366f1;
            transition: border-color 0.3s;
        }
        #player-name-input:focus {
            outline: none;
            border-color: #a5b4fc;
        }

        #leaderboard ol {
            list-style-type: decimal;
            padding-left: 2rem;
        }
        #leaderboard li {
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen overflow-hidden">

    <!-- ì£¼ ê²Œì„ ì»¨í…Œì´ë„ˆ: Tailwind ë†’ì´ í´ë˜ìŠ¤ë¥¼ ì œê±°í•˜ê³  CSSì—ì„œ ì œì–´ -->
    <div id="game-container" class="w-full max-w-md bg-gray-600 rounded-lg shadow-2xl flex flex-col relative overflow-hidden border-4 border-gray-700">
        
        <!-- ìƒë‹¨ ì •ë³´ ë°” (ì§ˆë¬¸, ì ìˆ˜) -->
        <div class="bg-gray-900 text-white p-4 shadow-lg z-20">
            <div id="question" class="text-center text-lg md:text-xl min-h-[5rem] flex items-center justify-center px-2"></div>
            <div id="player-info" class="absolute top-4 left-4 text-lg font-bold">Player: <span id="player-name-display"></span></div>
            <div class="absolute top-4 right-4 text-lg font-bold">ì ìˆ˜: <span id="score">0</span></div>
        </div>

        <!-- ê²Œì„ í™”ë©´ (ë„ë¡œ) -->
        <div id="game-screen" class="flex-1 relative">
            <div class="road-line" style="left: 33.33%; transform: translateX(-50%);"></div>
            <div class="road-line" style="left: 66.66%; transform: translateX(-50%);"></div>
            <div id="car" class="w-12 h-16 absolute bottom-8 left-1/2 -translate-x-1/2 text-5xl z-10">ğŸš“</div>
            <div id="answers-container" class="absolute w-full h-24 flex justify-around" style="top: 0;"></div>
        </div>

        <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ (ì „ì§„ ë²„íŠ¼ ì¶”ê°€) -->
        <div class="bg-gray-900 p-2 flex justify-center space-x-2 sm:hidden z-20">
            <button id="move-left-btn" class="w-1/3 bg-blue-500 text-white font-bold py-4 px-4 rounded-lg text-2xl active:bg-blue-700">â—€</button>
            <button id="move-forward-btn" class="w-1/3 bg-green-500 text-white font-bold py-4 px-4 rounded-lg text-2xl active:bg-green-700">â–²</button>
            <button id="move-right-btn" class="w-1/3 bg-blue-500 text-white font-bold py-4 px-4 rounded-lg text-2xl active:bg-blue-700">â–¶</button>
        </div>

        <!-- ì‹œì‘ / ì¬ì‹œì‘ í™”ë©´ ëª¨ë‹¬ -->
        <div id="start-screen" class="modal absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-30 px-4">
            <h1 id="start-title" class="text-5xl font-bold text-white mb-4 text-center">ì¼ì•¼êµ¬ë„í•˜ê¸° í€´ì¦ˆ</h1>
            <p id="start-desc" class="text-yellow-300 text-lg mb-6 text-center">ì •ë‹µì„ í–¥í•´ ëŒì§„í•˜ì„¸ìš”!</p>
            
            <div id="name-input-container" class="w-full max-w-sm mb-4">
                <label for="player-name-input" class="block text-white text-center mb-2">í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</label>
                <input type="text" id="player-name-input" class="w-full px-4 py-2 rounded-lg bg-gray-200 text-gray-800 text-center font-bold" placeholder="ì´ë¦„" maxlength="10">
            </div>

            <button id="start-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-2xl shadow-lg transform hover:scale-105 transition-transform">
                ê²Œì„ ì‹œì‘
            </button>
            
            <div id="leaderboard" class="mt-8 w-full max-w-sm text-white bg-gray-800 bg-opacity-50 p-4 rounded-lg hidden">
                <h3 class="text-2xl text-yellow-300 font-bold text-center mb-2">ï¿½ ëª…ì˜ˆì˜ ì „ë‹¹ ğŸ†</h3>
                <ol id="leaderboard-list" class="text-lg"></ol>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        // --- DOM ìš”ì†Œ ì„ íƒ ---
        const car = document.getElementById('car');
        const gameScreen = document.getElementById('game-screen');
        const questionEl = document.getElementById('question');
        const scoreEl = document.getElementById('score');
        const answersContainer = document.getElementById('answers-container');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const startTitle = document.getElementById('start-title');
        const startDesc = document.getElementById('start-desc');
        const moveLeftBtn = document.getElementById('move-left-btn');
        const moveRightBtn = document.getElementById('move-right-btn');
        const moveForwardBtn = document.getElementById('move-forward-btn'); // ì „ì§„ ë²„íŠ¼ ì¶”ê°€
        const roadLines = document.querySelectorAll('.road-line');
        const playerNameInput = document.getElementById('player-name-input');
        const playerNameDisplay = document.getElementById('player-name-display');
        const playerInfo = document.getElementById('player-info');
        const nameInputContainer = document.getElementById('name-input-container');
        const leaderboard = document.getElementById('leaderboard');
        const leaderboardList = document.getElementById('leaderboard-list');

        // --- Firebase ì„¤ì • ---
        let db;
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyDcagfE320vd1DuT6uZ8mHhVy2yB74C1q0",
                authDomain: "grammar-294b6.firebaseapp.com",
                projectId: "grammar-294b6",
                storageBucket: "grammar-294b6.appspot.com",
                messagingSenderId: "865611264169",
                appId: "1:865611264169:web:84b9e6d784c3b41bd139b8"
            };
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);
            signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // --- ì‚¬ìš´ë“œ ì„¤ì • ---
        let audioCtx;
        function setupAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            } else if (type === 'incorrect') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            }
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
        }

        // --- í€´ì¦ˆ ë°ì´í„° ---
        const quizData = [
            { question: "'ì¼ì•¼êµ¬ë„í•˜ê¸°'ì˜ ëœ»ì€?", answers: ["ê°• ê±´ë„ˆê¸° ì¢‹ì€ ë‚ ", "í•˜ë£»ë°¤ì— ê°• 9ë²ˆ ê±´ë„ˆê¸°", "ë°¤ë‚šì‹œ ê¸°ë¡"], correct: 1 },
            { question: "ì´ ê¸€ì˜ ì‘ê°€ëŠ” ëˆ„êµ¬ì¸ê°€?", answers: ["ë°•ì œê°€", "ì •ì•½ìš©", "ë°•ì§€ì›"], correct: 2 },
            { question: "ì´ ê¸€ì˜ í•µì‹¬ ì£¼ì œëŠ”?", answers: ["ìì—°ì˜ ì•„ë¦„ë‹¤ì›€", "ì™¸ë¬¼ì— í˜„í˜¹ë˜ì§€ ì•ŠëŠ” ìì„¸", "ìš°ì •ì˜ ì†Œì¤‘í•¨"], correct: 1 },
            { question: "ì´ ê¸€ì˜ ê°ˆë˜ë¡œ ì ì ˆí•œ ê²ƒì€?", answers: ["ì†Œì„¤", "ê¸°í–‰ ìˆ˜í•„", "í¬ê³¡"], correct: 1 },
            { question: "ê¸€ì“´ì´ê°€ ê°•ë¬¼ ì†Œë¦¬ë¥¼ ë¹„ìœ í•œ ëŒ€ìƒì´ ì•„ë‹Œ ê²ƒì€?", answers: ["ì „ê±°, ì „ê¸°", "ë§Œë¦¬ì¥ì„±", "ì²œë‘¥, ë²ˆê°œ"], correct: 1 },
            { question: "ê¸€ì“´ì´ì— ë”°ë¥´ë©´, ê°•ë¬¼ ì†Œë¦¬ëŠ” ë¬´ì—‡ì— ë‹¬ë ¤ ìˆëŠ”ê°€?", answers: ["ê°•ë¬¼ì˜ ê¹Šì´", "ë“£ëŠ” ì´ì˜ ë§ˆìŒê°€ì§", "ë‚ ì”¨"], correct: 1 },
            { question: "ê³„ê³¡ ë¬¼ì†Œë¦¬ê°€ ë‹¤ë¥´ê²Œ ë“¤ë¦° ì´ìœ ëŠ”?", answers: ["ì‹¤ì œ ì†Œë¦¬ê°€ ë³€í•´ì„œ", "ë§ˆìŒì† ìƒê°ì— ë”°ë¼", "ê·€ê°€ ì•„íŒŒì„œ"], correct: 1 },
            { question: "ë‚®ì— ê°• ê±´ë„ˆë˜ ì‚¬ëŒë“¤ì´ í•˜ëŠ˜ì„ ë³¸ ì´ìœ ëŠ”?", answers: ["ê¸°ë„í•˜ê¸° ìœ„í•´", "ë¬¼ì„ ë³´ë©´ ì–´ì§€ëŸ¬ì›Œì„œ", "ë³„ì„ ë³´ê¸° ìœ„í•´"], correct: 1 },
            { question: "ë‚®ì— ê°•ë¬¼ ì†Œë¦¬ë¥¼ ë“£ì§€ ëª»í•œ ì´ìœ ëŠ”?", answers: ["ê°•ì´ ì¡°ìš©í•´ì„œ", "ëˆˆì•ì˜ ìœ„í—˜ì—ë§Œ ì§‘ì¤‘í•´ì„œ", "ê·€ë§ˆê°œë¥¼ í•´ì„œ"], correct: 1 },
            { question: "ë°¤ì— ê°•ì„ ê±´ë„ ë•Œ ë‘ë ¤ì›€ì„ ëŠë‚€ ê¹Œë‹­ì€?", answers: ["ê·€(ì†Œë¦¬)ì—ë§Œ ì˜ì¡´í•´ì„œ", "ê·€ì‹ ì„ ë´ì„œ", "ê¸¸ì„ ìƒì–´ì„œ"], correct: 0 },
            { question: "ê¸€ì“´ì´ê°€ ê¹¨ë‹¬ì€ 'ë„(é“)'ì˜ í•µì‹¬ì€?", answers: ["ë§ˆìŒì„ ë‹¤ìŠ¤ë ¤ì•¼ í•œë‹¤", "ì—´ì‹¬íˆ ê³µë¶€í•´ì•¼ í•œë‹¤", "ì¹œêµ¬ì™€ ì‚¬ì´ì¢‹ê²Œ ì§€ë‚´ì•¼ í•œë‹¤"], correct: 0 },
            { question: "ì£½ìŒì„ ê°ì˜¤í•œ í›„ ê¸€ì“´ì´ì˜ ë§ˆìŒ ìƒíƒœëŠ”?", answers: ["ë”ìš± ë¶ˆì•ˆí•´ì§", "ì•„ë¬´ ê±±ì • ì—†ì´ í¸ì•ˆí•´ì§", "ìŠ¬í¼ì§"], correct: 1 },
            { question: "ê¸€ì“´ì´ê°€ ê°•ì„ ë¹„ìœ í•œ ëŒ€ìƒì´ ì•„ë‹Œ ê²ƒì€?", answers: ["ë‚´ ì˜·, ë‚´ ëª¸", "ëŒ€ì§€", "ë‚´ ì¹œêµ¬"], correct: 2 },
            { question: "ë³¸ë¬¸ì— ì¸ìš©ëœ ê³ ì‚¬ ì† ì¸ë¬¼ì€?", answers: ["ê³µì", "ë§¹ì", "ìš°ì„ê¸ˆ"], correct: 2 },
            { question: "ìš°ì„ê¸ˆ ê³ ì‚¬ì˜ êµí›ˆì€?", answers: ["ìš©ì„ ì˜ ë‹¤ë¤„ì•¼ í•œë‹¤", "ì£½ê³  ì‚¬ëŠ” ë¬¸ì œì— ì´ˆì—°í•´ì•¼ í•œë‹¤", "ë°°ë¥¼ ì˜ ë§Œë“¤ì–´ì•¼ í•œë‹¤"], correct: 1 },
            { question: "ì†Œë¦¬, ë¹›ê¹”ê³¼ ê°™ì´ ê¸€ì“´ì´ê°€ ê²½ê³„í•œ ê²ƒì€?", answers: ["ë‚´ë¬¼(å…§ç‰©)", "ì™¸ë¬¼(å¤–ç‰©)", "ì§„ë¬¼(çœç‰©)"], correct: 1 },
            { question: "ê¸€ì“´ì´ëŠ” ì„¸ìƒì‚´ì´ê°€ ê°• ê±´ë„ˆëŠ” ê²ƒë³´ë‹¤ ì–´ë–»ë‹¤ê³  í–ˆë‚˜?", answers: ["í›¨ì”¬ ë” ìœ„í—˜í•˜ë‹¤", "í›¨ì”¬ ë” ì•ˆì „í•˜ë‹¤", "ë¹„ìŠ·í•˜ë‹¤"], correct: 0 },
            { question: "ê¸€ì“´ì´ê°€ ê²½ê³ í•˜ê³ ì í•˜ëŠ” ëŒ€ìƒì€?", answers: ["ë§ˆìŒì„ ì˜ ë‹¤ìŠ¤ë¦¬ëŠ” ì‚¬ëŒ", "ìì‹ ì˜ ê·€ì™€ ëˆˆë§Œ ë¯¿ëŠ” ì‚¬ëŒ", "ì—¬í–‰ì„ ì‹«ì–´í•˜ëŠ” ì‚¬ëŒ"], correct: 1 },
            { question: "'ì¼ì•¼êµ¬ë„í•˜ê¸°'ê°€ ì‹¤ë¦° ë°•ì§€ì›ì˜ ì—¬í–‰ê¸°ëŠ”?", answers: ["ì—´í•˜ì¼ê¸°", "ì‚°ì„±ì¼ê¸°", "ì„œìœ ê²¬ë¬¸"], correct: 0 },
            { question: "ì™¸ë¶€ ì‚¬ë¬¼ì„ ëœ»í•˜ëŠ” í•œìì–´ 'ì™¸ë¬¼'ì€?", answers: ["å¤–æ°´", "å¤–ç‰©", "å¤–å¿ƒ"], correct: 1 }
        ];

        let carPosition, score, currentQuestionIndex, gameLoopId, playerName;
        let isGameActive = false;
        let questionInProgress = false;

        function init() {
            carPosition = 1; score = 0; currentQuestionIndex = 0;
            isGameActive = true; questionInProgress = false;
            playerInfo.classList.remove('hidden');
            playerNameDisplay.textContent = playerName;
            roadLines.forEach(line => line.style.animationPlayState = 'running');
            updateScore();
            shuffleQuiz();
            loadQuestion();
            updateCarPosition();
            nameInputContainer.classList.add('hidden');
            leaderboard.classList.add('hidden');
            startScreen.classList.add('hidden');
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoop();
        }
        
        function gameLoop() {
            if (!isGameActive) return;
            const carRect = car.getBoundingClientRect();
            const answersRect = answersContainer.getBoundingClientRect();
            if (questionInProgress && answersRect.bottom > carRect.top && answersRect.top < carRect.bottom) {
                handleCollision();
            }
            if (questionInProgress && answersRect.top > window.innerHeight) {
                handleCollision(true);
            }
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function handleCollision(missed = false) {
            if (!questionInProgress) return;
            questionInProgress = false; 
            answersContainer.style.animationPlayState = 'paused';
            const currentQuiz = quizData[currentQuestionIndex];
            const correctGate = answersContainer.children[currentQuiz.correct];
            if (missed) {
                if (correctGate) correctGate.classList.replace('bg-blue-500', 'bg-yellow-500');
                playSound('incorrect');
            } else {
                if (carPosition === currentQuiz.correct) {
                    score += 5;
                    updateScore();
                    correctGate.classList.replace('bg-blue-500', 'bg-green-500');
                    playSound('correct');
                } else {
                    const wrongGate = answersContainer.children[carPosition];
                    if (wrongGate) wrongGate.classList.replace('bg-blue-500', 'bg-red-600');
                    if (correctGate) correctGate.classList.replace('bg-blue-500', 'bg-green-500');
                    playSound('incorrect');
                }
            }
            currentQuestionIndex++;
            setTimeout(loadQuestion, 1000);
        }

        // í”Œë ˆì´ì–´ê°€ ì¦‰ì‹œ ì •ë‹µì„ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” í•¨ìˆ˜
        function checkAnswerNow() {
            if (!questionInProgress) return;
            handleCollision(false);
        }

        function shuffleQuiz() {
            for (let i = quizData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [quizData[i], quizData[j]] = [quizData[j], quizData[i]];
            }
        }

        function loadQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                endGame();
                return;
            }
            questionInProgress = true;
            const currentQuiz = quizData[currentQuestionIndex];
            questionEl.textContent = `Q${currentQuestionIndex + 1}. ${currentQuiz.question}`;
            answersContainer.innerHTML = '';
            currentQuiz.answers.forEach((answer) => {
                const answerEl = document.createElement('div');
                answerEl.className = 'w-1/3 h-full flex items-center justify-center text-white text-base md:text-lg font-bold p-2 text-center bg-blue-500 bg-opacity-75 border-2 border-blue-300 rounded-lg';
                answerEl.textContent = answer;
                answersContainer.appendChild(answerEl);
            });
            answersContainer.classList.remove('falling');
            void answersContainer.offsetWidth; 
            answersContainer.style.animationPlayState = 'running';
            answersContainer.classList.add('falling');
        }
        
        async function endGame() {
            isGameActive = false;
            cancelAnimationFrame(gameLoopId);
            roadLines.forEach(line => line.style.animationPlayState = 'paused');
            await saveScore(playerName, score);
            await displayLeaderboard();
            questionEl.textContent = `í€´ì¦ˆ ì™„ë£Œ! ìµœì¢… ì ìˆ˜: ${score}ì `;
            answersContainer.innerHTML = '';
            playerInfo.classList.add('hidden');
            startTitle.textContent = "ê²Œì„ í´ë¦¬ì–´!";
            startDesc.innerHTML = `ìµœì¢… ì ìˆ˜: <span class="text-2xl text-white font-bold">${score}</span>ì `;
            startButton.textContent = "ë‹¤ì‹œ ì‹œì‘";
            nameInputContainer.classList.remove('hidden');
            leaderboard.classList.remove('hidden');
            startScreen.classList.remove('hidden');
        }

        function updateCarPosition() {
            const laneWidth = gameScreen.offsetWidth / 3;
            car.style.left = `${(carPosition * laneWidth) + (laneWidth / 2)}px`;
        }
        
        function moveCar(direction) {
            if (!isGameActive) return;
            if (direction === 'left' && carPosition > 0) carPosition--;
            else if (direction === 'right' && carPosition < 2) carPosition++;
            updateCarPosition();
        }
        
        function updateScore() {
            scoreEl.textContent = score;
        }

        async function saveScore(name, score) {
            if (!db) return;
            try {
                await addDoc(collection(db, "scores"), { name: name, score: score, createdAt: serverTimestamp() });
            } catch (e) { console.error("Error adding document: ", e); }
        }

        async function displayLeaderboard() {
            if (!db) return;
            leaderboardList.innerHTML = '<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>';
            try {
                const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                leaderboardList.innerHTML = '';
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<li>ì•„ì§ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${data.name}</span><span>${data.score}ì </span>`;
                    leaderboardList.appendChild(li);
});
            } catch (e) {
                console.error("Error getting documents: ", e);
                leaderboardList.innerHTML = '<li>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
            }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        startButton.addEventListener('click', () => {
            setupAudio();
            playerName = playerNameInput.value.trim();
            if (!playerName) {
                playerNameInput.placeholder = "ì´ë¦„ì„ ê¼­ ì…ë ¥í•´ì£¼ì„¸ìš”!";
                playerNameInput.classList.add('border-red-500');
                setTimeout(() => {
                    playerNameInput.classList.remove('border-red-500');
                    playerNameInput.placeholder = "ì´ë¦„";
                }, 1500);
                return;
            }
            init();
        });

        document.addEventListener('keydown', (e) => {
            if (startScreen.classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') moveCar('left');
                else if (e.key === 'ArrowRight') moveCar('right');
                else if (e.key === 'ArrowUp' || e.key === ' ') {
                    e.preventDefault();
                    checkAnswerNow(); // ì¦‰ì‹œ ì •ë‹µ í™•ì¸
                }
            } else if (e.key === 'Enter') {
                startButton.click();
            }
        });

        moveLeftBtn.addEventListener('click', () => moveCar('left'));
        moveRightBtn.addEventListener('click', () => moveCar('right'));
        moveForwardBtn.addEventListener('click', checkAnswerNow); // ì „ì§„ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€

        window.addEventListener('resize', () => {
            if (isGameActive) updateCarPosition();
        });
        
    </script>
</body>
</html>
ï¿½